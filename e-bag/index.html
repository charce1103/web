<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ³¢æ³¢ç†Šçš„çµ‚æ¥µé˜²ç½æŒ‘æˆ°</title>
    
    <!-- å¼•å…¥ Tailwind CSS (æ¨£å¼åº«) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- å¼•å…¥ Babel (å°‡ JSX è½‰ç‚º JavaScript) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- è¨­å®š Import Map: å¼·åˆ¶å…±ç”¨ React å¯¦ä¾‹ -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client?deps=react@18.2.0",
            "lucide-react": "https://esm.sh/lucide-react@0.468.0?deps=react@18.2.0"
        }
    }
    </script>

    <!-- è‡ªè¨‚å­—é«”èˆ‡å‹•ç•«æ¨£å¼ -->
    <style>
        body {
            font-family: "Comic Sans MS", "Chalkboard SE", "Marker Felt", "å¾®è»Ÿæ­£é»‘é«”", sans-serif;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(-5%); }
            50% { transform: translateY(5%); }
        }
        .animate-bounce-slow { animation: bounce-slow 3s infinite; }
        
        @keyframes spin-slow {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .animate-spin-slow { animation: spin-slow 10s linear infinite; }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        .animate-shake { animation: shake 0.5s ease-in-out infinite; }
        
        @keyframes pop-in {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .animate-pop-in { animation: pop-in 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        @keyframes slide {
            0% { transform: translateX(0); }
            100% { transform: translateX(-50%); }
        }
        .animate-slide { animation: slide 20s linear infinite; }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- éŠæˆ²ä¸»ç¨‹å¼ç¢¼ (ä½¿ç”¨ module æ¨¡å¼) -->
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Trophy, AlertTriangle, CheckCircle, XCircle, Backpack, Info, RefreshCw, 
            Minus, Hand, Sun, Snowflake, User, Calendar, Ruler, Star, Heart, Zap, 
            Medal, Moon, CloudRain, Wind, Battery, MapPin, Home, ArrowRight, Play, 
            ThermometerSun, Umbrella 
        } from 'lucide-react';

        // --- è³‡æ–™è¨­å®š ---
        const ITEMS_DB = [
            // ğŸŸ¢ é£²é£Ÿèˆ‡æ°´
            { id: 'f1', name: 'ç“¶è£æ°´', weight: 650, score: 20, type: 1, icon: 'ğŸ’§', stackable: true, tags: ['water'], desc: 'ç”Ÿå‘½ä¹‹æº' },
            { id: 'f2', name: 'ç‡Ÿé¤Šå£ç³§', weight: 100, score: 10, type: 1, icon: 'ğŸª', stackable: true, tags: ['food'], desc: 'ç†±é‡é«˜' },
            { id: 'f3', name: 'æ˜“é–‹ç½é ­', weight: 350, score: 8, type: 1, icon: 'ğŸ¥«', stackable: true, tags: ['food'], desc: 'è€æ”¾' },
            { id: 'f4', name: 'å·§å…‹åŠ›', weight: 50, score: 10, type: 1, icon: 'ğŸ«', stackable: true, tags: ['food', 'comfort'], desc: 'è£œè¡€ç³–å¿ƒæƒ…' },
            { id: 'f5', name: 'æ³¡éºµ', weight: 100, score: 5, type: 1, icon: 'ğŸœ', stackable: true, tags: ['food'], desc: 'éœ€ç†±æ°´' },
            { id: 'f6', name: 'æ£’æ£’ç³–', weight: 20, score: 5, type: 1, icon: 'ğŸ­', stackable: true, tags: ['comfort'], desc: 'å®‰æ’«ç”¨' },
            { id: 'x5', name: 'å¤§ç½æ±½æ°´', weight: 1200, score: -5, type: 1, icon: 'ğŸ¥¤', stackable: true, tags: [], desc: 'å¤ªé‡ä¸è§£æ¸´' },
            { id: 'x6', name: 'æ´‹èŠ‹ç‰‡', weight: 150, score: -2, type: 1, icon: 'ğŸ¥”', stackable: true, tags: [], desc: 'ä½”ç©ºé–“' },

            // ğŸŸ¡ è¡£ç‰©ä¿æš–
            { id: 'c1', name: 'è¼•ä¾¿é›¨è¡£', weight: 50, score: 15, type: 2, icon: 'â˜”', stackable: true, tags: ['rain', 'warmth', 'wind'], desc: 'é˜²é›¨é˜²é¢¨' },
            { id: 'c2', name: 'ä¿æš–é‹ç®”æ¯¯', weight: 50, score: 15, type: 2, icon: 'â›º', stackable: true, tags: ['warmth', 'sleep'], desc: 'é˜²å¤±æº«ç¥å™¨' },
            { id: 'c3', name: 'è¥ªå­', weight: 40, score: 8, type: 2, icon: 'ğŸ§¦', stackable: true, tags: ['warmth', 'hygiene'], desc: 'ä¿æš–ä¹¾ç‡¥' },
            { id: 'c4', name: 'æš–æš–åŒ…', weight: 30, score: 8, type: 2, icon: 'ğŸ”¥', stackable: true, tags: ['warmth'], desc: 'ç¦¦å¯’' },
            { id: 'c5', name: 'æ¯›å·¾', weight: 100, score: 8, type: 2, icon: 'ğŸ§£', stackable: true, tags: ['hygiene', 'warmth'], desc: 'æ¸…æ½”ä¿æš–' },
            { id: 'c6', name: 'å·¥ä½œæ‰‹å¥—', weight: 50, score: 10, type: 2, icon: 'ğŸ§¤', stackable: false, tags: ['protect_hands'], desc: 'ä¿è­·é›™æ‰‹' },
            { id: 'c7', name: 'ç¾½çµ¨è¡£', weight: 800, score: 5, type: 2, icon: 'ğŸ§¥', stackable: false, tags: ['warmth'], desc: 'æš–ä½†ä½”ä½' },
            { id: 'c8', name: 'é®é™½å¸½', weight: 60, score: 8, type: 2, icon: 'ğŸ§¢', stackable: false, tags: ['sun'], desc: 'é˜²æ›¬' },
            { id: 'c9', name: 'æ›æ´—è¡£ç‰©', weight: 200, score: 8, type: 2, icon: 'ğŸ‘•', stackable: false, tags: ['hygiene'], desc: 'ä¿æŒæ¸…æ½”' },

            // ğŸ”´ é†«ç™‚è¡›ç”Ÿ
            { id: 'm1', name: 'å€‹äººè—¥å“', weight: 20, score: 20, type: 3, icon: 'ğŸ’Š', stackable: false, tags: ['medical'], desc: 'æ•‘å‘½è—¥' },
            { id: 'm2', name: 'æ€¥æ•‘åŒ…', weight: 150, score: 12, type: 3, icon: 'ğŸ¥', stackable: false, tags: ['medical', 'injury'], desc: 'å¤–å‚·è™•ç†' },
            { id: 'm3', name: 'å£ç½©', weight: 20, score: 10, type: 3, icon: 'ğŸ˜·', stackable: true, tags: ['hygiene', 'dust'], desc: 'é˜²å¡µé˜²æ¯’' },
            { id: 'm4', name: 'æ¿•ç´™å·¾', weight: 150, score: 8, type: 3, icon: 'ğŸ§»', stackable: true, tags: ['hygiene', 'toilet'], desc: 'æ¸…æ½”èº«é«”' },
            { id: 'm5', name: 'è¡›ç”Ÿç´™', weight: 100, score: 8, type: 3, icon: 'ğŸ§»', stackable: true, tags: ['hygiene', 'toilet'], desc: 'å¦‚å»å¿…å‚™' },
            { id: 'm6', name: 'è¡›ç”Ÿæ£‰', weight: 50, score: 8, type: 3, icon: 'ğŸŒ¸', stackable: true, tags: ['hygiene', 'injury'], desc: 'ç”Ÿç†/æ­¢è¡€' },
            { id: 'm7', name: 'ä¹¾æ´—æ‰‹', weight: 80, score: 8, type: 3, icon: 'ğŸ§¼', stackable: false, tags: ['hygiene'], desc: 'æ¶ˆæ¯’æ‰‹éƒ¨' },

            // ğŸ”µ å·¥å…·é€šè¨Š
            { id: 't1', name: 'æ‰‹é›»ç­’', weight: 150, score: 18, type: 4, icon: 'ğŸ”¦', stackable: false, tags: ['light'], desc: 'ç…§æ˜' },
            { id: 't2', name: 'å“¨å­', weight: 10, score: 20, type: 4, icon: 'ğŸ“£', stackable: false, tags: ['signal'], desc: 'æ±‚æ•‘' },
            { id: 't3', name: 'æ”¶éŸ³æ©Ÿ', weight: 300, score: 10, type: 4, icon: 'ğŸ“»', stackable: false, tags: ['info'], desc: 'è½ç½æƒ…' },
            { id: 't4', name: 'é›»æ± ', weight: 100, score: 8, type: 4, icon: 'ğŸ”‹', stackable: true, tags: ['power'], desc: 'å‚™ç”¨é›»åŠ›' },
            { id: 't5', name: 'å¤§åƒåœ¾è¢‹', weight: 30, score: 8, type: 4, icon: 'ğŸ›ï¸', stackable: true, tags: ['rain', 'water_storage'], desc: 'é˜²æ°´è¬ç”¨' },
            { id: 't6', name: 'è¡Œå‹•é›»æº', weight: 250, score: 10, type: 4, icon: 'âš¡', stackable: false, tags: ['power'], desc: 'æ‰‹æ©Ÿå……é›»' },
            { id: 't7', name: 'ç‘å£«åˆ€', weight: 100, score: 5, type: 4, icon: 'ğŸ”ª', stackable: false, tags: ['tool'], desc: 'å¤šåŠŸèƒ½' },
            { id: 'x1', name: 'Switch', weight: 400, score: -5, type: 4, icon: 'ğŸ®', stackable: true, tags: ['comfort'], desc: 'è€—é›»' },
            { id: 'x7', name: 'å¹³æ¿', weight: 500, score: -5, type: 4, icon: 'ğŸ“±', stackable: false, tags: ['comfort'], desc: 'æ˜“ç¢' },

            // ğŸŸ£ é‡è¦æ–‡ä»¶/å€‹äºº
            { id: 'd1', name: 'é˜²ç½å¡', weight: 5, score: 25, type: 5, icon: 'ğŸ“', stackable: false, tags: ['contact'], desc: 'è¯çµ¡å®¶äºº' },
            { id: 'd2', name: 'èº«åˆ†è­‰ä»¶', weight: 10, score: 15, type: 5, icon: 'ğŸ†”', stackable: false, tags: ['id'], desc: 'è­‰æ˜èº«åˆ†' },
            { id: 'd3', name: 'é›¶éŒ¢', weight: 150, score: 8, type: 5, icon: 'ğŸ’°', stackable: false, tags: ['buy'], desc: 'æŠ•å¹£é›»è©±' },
            { id: 'd4', name: 'å…¨å®¶ç¦', weight: 5, score: 10, type: 5, icon: 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦', stackable: false, tags: ['comfort'], desc: 'å¿ƒéˆæ”¯æŸ±' },
            { id: 'x2', name: 'å¤§ç©å¶', weight: 300, score: -2, type: 5, icon: 'ğŸ§¸', stackable: false, tags: ['comfort'], desc: 'ä½”é«”ç©' },
            { id: 'x3', name: 'å…¨å¥—æ¼«ç•«', weight: 1000, score: -5, type: 5, icon: 'ğŸ“š', stackable: true, tags: ['comfort'], desc: 'å¤ªé‡' },
        ];

        const SCENARIO_DB = [
            // ğŸ•’ æ™‚é–“èˆ‡å…‰ç·š
            { id: 'darkness', text: 'çªç„¶ä¸€ç‰‡æ¼†é»‘ï¼Œçœ‹ä¸åˆ°è·¯ï¼', reqTag: 'light', conditions: { time: 'night' }, success: 'æ‰“é–‹æ‰‹é›»ç­’ï¼Œçœ‹æ¸…æ¥šäº†ï¼', fail: 'å¤ªæš—äº†ï¼Œè·Œå€’å—å‚·...', damage: 20 },
            
            // ğŸŒ¡ï¸ æ°£æº«èˆ‡å¤©æ°£
            { id: 'freezing', text: 'å¯’æµä¾†è¥²ï¼Œèº«é«”ä¸€ç›´ç™¼æŠ–...', reqTag: 'warmth', conditions: { season: 'winter' }, success: 'ç”¨äº†ä¿æš–ç”¨å“ï¼Œå¥½æš–å’Œï¼', fail: 'å¥½å†·...å¿«å¤±æº«äº†...', damage: 30 },
            { id: 'scorching', text: 'å¤ªé™½å¥½å¤§ï¼Œæ›¬å¾—é ­æ˜çœ¼èŠ±ï¼', reqTag: 'sun', conditions: { season: 'summer' }, success: 'æˆ´ä¸Šå¸½å­é®é™½ï¼Œèˆ’æœå¤šäº†ã€‚', fail: 'é ­å¥½æšˆ...ä¸­æš‘äº†...', damage: 20 },
            { id: 'pouring_rain', text: 'ä¸‹å¤§é›¨äº†ï¼å…¨èº«éƒ½è¦æ¿•é€äº†ï¼', reqTag: 'rain', conditions: { disaster: 'flood' }, success: 'ç©¿ä¸Šé›¨è¡£ï¼Œèº«é«”ä¹¾ä¹¾çš„ã€‚', fail: 'å…¨èº«æ¿•é€ï¼Œåˆæ¿•åˆå†·...', damage: 25 },
            
            // ğŸšï¸ ç½å®³ç‰¹å®š
            { id: 'dust_storm', text: 'æˆ¿å­å€’å¡Œæšèµ·ç²‰å¡µï¼Œå¥½é›£å‘¼å¸ï¼', reqTag: 'dust', conditions: { disaster: 'earthquake' }, success: 'æˆ´ä¸Šå£ç½©ï¼Œå‘¼å¸é †æš¢ï¼', fail: 'å’³å’³å’³...å¸å…¥ç°å¡µ...', damage: 15 },
            { id: 'debris', text: 'è·¯ä¸Šéƒ½æ˜¯ç¢ç»ç’ƒï¼Œæ‰‹å¯èƒ½æœƒå‰²å‚·ã€‚', reqTag: 'protect_hands', conditions: { disaster: 'earthquake' }, success: 'æˆ´ä¸Šæ‰‹å¥—ï¼Œå®‰å…¨æ¬é–‹éšœç¤™ã€‚', fail: 'æ‰‹è¢«åŠƒå‚·äº†ï¼Œå¥½ç—›...', damage: 15 },
            
            // ğŸ§‚ ç”Ÿç†éœ€æ±‚ (é€šç”¨)
            { id: 'thirsty_extreme', text: 'èµ°äº†å¥½ä¹…ï¼Œå–‰åš¨ä¹¾å¾—åƒç«ç‡’...', reqTag: 'water', type: 'universal', success: 'å–äº†æ°´ï¼Œå¾©æ´»äº†ï¼', fail: 'å¥½æ¸´...æ²’åŠ›æ°£äº†...', damage: 30 },
            { id: 'hungry', text: 'è‚šå­å’•åš•å«ï¼Œæ²’åŠ›æ°£èµ°è·¯äº†ã€‚', reqTag: 'food', type: 'universal', success: 'åƒäº†æ±è¥¿ï¼Œåˆæœ‰åŠ›æ°£äº†ï¼', fail: 'å¥½é¤“...èµ°ä¸å‹•äº†...', damage: 20 },
            { id: 'toilet_emergency', text: 'ç³Ÿç³•ï¼è‚šå­ç—›ï¼Œæ€¥éœ€ä¸Šå»æ‰€ï¼', reqTag: 'toilet', type: 'universal', success: 'å‘¼ï½å¥½éšªæœ‰å¸¶è¡›ç”Ÿç´™ã€‚', fail: 'æ…˜äº†...æ²’æœ‰ç´™... (å´©æ½°)', damage: 15 },
            { id: 'small_injury', text: 'å“å‘€ï¼è¢«è·¯é‚Šçš„æ¨¹æåˆ®å‚·æµè¡€ï¼', reqTag: 'injury', type: 'universal', success: 'ç”¨æ€¥æ•‘åŒ…æ¶ˆæ¯’åŒ…ç´®ï¼Œæ²’äº‹ã€‚', fail: 'å‚·å£æ²’è™•ç†ï¼Œå¥½ç—›...', damage: 20 },
            
            // ğŸ§  å¿ƒç†èˆ‡ç¤¾äº¤ (é€šç”¨)
            { id: 'panic', text: 'å¿ƒè£¡å¥½å®³æ€•ï¼Œå¥½æƒ³å›å®¶...', reqTag: 'comfort', type: 'universal', success: 'æŠ±è‘—ç†Ÿæ‚‰çš„æ±è¥¿ï¼Œå¹³éœäº†ã€‚', fail: 'å¥½å®³æ€•...å—šå—šå—š...', damage: 15 },
            { id: 'lost_contact', text: 'åˆ°äº†æ”¶å®¹æ‰€ï¼Œæ‰¾ä¸åˆ°çˆ¸çˆ¸åª½åª½...', reqTag: 'contact', type: 'universal', success: 'çœ‹é˜²ç½å¡æ‰“é›»è©±ï¼Œè¯çµ¡ä¸Šäº†ï¼', fail: 'æ²’æœ‰é›»è©±ï¼Œæ€éº¼è¾¦... (ç„¦æ…®)', damage: 25 },
        ];

        const CATEGORIES = { 1: 'é£²é£Ÿ', 2: 'è¡£ç‰©', 3: 'é†«ç™‚', 4: 'å·¥å…·', 5: 'æ–‡ä»¶' };
        const PROFILE_CONFIG = {
            grades: [
                { id: 'low', label: 'ä½å¹´ç´š', weightLimit: 3000 },
                { id: 'mid', label: 'ä¸­å¹´ç´š', weightLimit: 4500 },
                { id: 'high', label: 'é«˜å¹´ç´š', weightLimit: 6000 },
            ],
            seasons: [
                { id: 'summer', label: 'å¤å¤©', icon: <Sun size={28}/> },
                { id: 'winter', label: 'å†¬å¤©', icon: <Snowflake size={28}/> },
            ],
            times: [
                { id: 'day', label: 'ç™½å¤©', icon: <Sun size={28}/> },
                { id: 'night', label: 'æ™šä¸Š', icon: <Moon size={28}/> },
            ],
            disasters: [
                { id: 'earthquake', label: 'åœ°éœ‡', icon: 'ğŸšï¸' },
                { id: 'flood', label: 'æ°´ç½', icon: 'ğŸŒŠ' },
            ]
        };

        const StatBar = ({ icon, value, color, max = 100 }) => (
            <div className="flex items-center gap-1.5 w-full">
                <div className="flex items-center text-white drop-shadow-md">
                    {icon}
                </div>
                <div className="flex-1 h-4 md:h-5 bg-gray-300 rounded-full overflow-hidden border-2 border-black shadow-inner">
                    <div 
                        className={`h-full transition-all duration-500 ${color}`} 
                        style={{ width: `${Math.max(0, Math.min(100, (value/max)*100))}%` }}
                    >
                    </div>
                </div>
                <span className="text-xs md:text-sm font-black text-white drop-shadow-md w-8 text-right">{value}</span>
            </div>
        );

        function SurvivalGame() {
            const [scene, setScene] = useState('menu'); 
            const [profile, setProfile] = useState({ grade: 'mid', season: 'winter', time: 'night', disaster: 'earthquake' });
            const [inventory, setInventory] = useState({});
            const [activeTab, setActiveTab] = useState(0);
            
            // æ—…ç¨‹ç‹€æ…‹
            const [hp, setHp] = useState(100);
            const [score, setScore] = useState(0); 
            const [progress, setProgress] = useState(0); 
            const [journeyEvents, setJourneyEvents] = useState([]); 
            const [currentEventIndex, setCurrentEventIndex] = useState(0);
            const [journeyLog, setJourneyLog] = useState([]);
            const [showEventModal, setShowEventModal] = useState(false);
            const [eventFeedback, setEventFeedback] = useState(null);

            const currentMaxWeight = PROFILE_CONFIG.grades.find(g => g.id === profile.grade)?.weightLimit || 4500;
            
            const calculateWeight = () => {
                return Object.entries(inventory).reduce((acc, [id, count]) => {
                    const item = ITEMS_DB.find(i => i.id === id);
                    return acc + (item ? item.weight * count : 0);
                }, 0);
            };
            const currentWeight = calculateWeight();

            // --- éŠæˆ²é‚è¼¯ ---

            const handleItemToggle = (item, action) => {
                if (action === 'add') {
                    setInventory(prev => {
                        const count = prev[item.id] || 0;
                        if (count >= 5) return prev;
                        return { ...prev, [item.id]: count + 1 };
                    });
                } else {
                    setInventory(prev => {
                        const count = prev[item.id] || 0;
                        if (count <= 0) return prev;
                        const next = { ...prev, [item.id]: count - 1 };
                        if (next[item.id] === 0) delete next[item.id];
                        return next;
                    });
                }
            };

            const generateEvents = () => {
                let pool = [];
                SCENARIO_DB.forEach(evt => {
                    if (evt.type === 'universal') {
                        pool.push(evt);
                    } else if (evt.conditions) {
                        let match = true;
                        if (evt.conditions.time && evt.conditions.time !== profile.time) match = false;
                        if (evt.conditions.season && evt.conditions.season !== profile.season) match = false;
                        if (evt.conditions.disaster && evt.conditions.disaster !== profile.disaster) match = false;
                        if (match) pool.push(evt);
                    }
                });

                const priorityEvents = pool.filter(e => e.type !== 'universal').sort(() => Math.random() - 0.5);
                const universalEvents = pool.filter(e => e.type === 'universal').sort(() => Math.random() - 0.5);
                let finalEvents = [...priorityEvents, ...universalEvents].slice(0, 5);
                while(finalEvents.length < 5) finalEvents.push(SCENARIO_DB.find(e => e.id === 'thirsty_extreme'));
                return finalEvents;
            };

            const startJourney = () => {
                if (currentWeight > currentMaxWeight) {
                    alert(`èƒŒåŒ…å¤ªé‡äº†ï¼è«‹æ¸›åˆ° ${currentMaxWeight}g ä»¥ä¸‹ã€‚`);
                    return;
                }
                if (Object.keys(inventory).length === 0) {
                    alert("èƒŒåŒ…æ˜¯ç©ºçš„ï¼Œé€™æ¨£å¾ˆå±éšªå–”ï¼");
                    return;
                }

                const events = generateEvents();
                setJourneyEvents(events);
                setHp(100);
                setScore(0);
                setProgress(0);
                setCurrentEventIndex(0);
                setJourneyLog([]);
                setShowEventModal(false);
                setEventFeedback(null);
                setScene('journey');
                
                advanceJourney(0, 0, events);
            };

            const advanceJourney = (targetIndex, currentProg, eventsList) => {
                if (targetIndex >= 5) {
                    setProgress(100);
                    setScore(prev => prev + hp); // å‰©é¤˜é«”åŠ›è½‰åˆ†æ•¸
                    setTimeout(() => setScene('report'), 1500);
                    return;
                }

                const eventProgressPoint = (targetIndex + 1) * 18; 
                const walk = setInterval(() => {
                    setProgress(prev => {
                        if (prev >= eventProgressPoint) {
                            clearInterval(walk);
                            setCurrentEventIndex(targetIndex);
                            setShowEventModal(true);
                            return eventProgressPoint;
                        }
                        return prev + 0.5;
                    });
                }, 30);
            };

            const handleUseItem = (item) => {
                const currentEvent = journeyEvents[currentEventIndex];
                if (!currentEvent) return;

                const isCorrect = item.tags.includes(currentEvent.reqTag);

                if (isCorrect) {
                    setEventFeedback({ type: 'success', text: currentEvent.success });
                    setScore(prev => prev + 100); // ç­”å°åŠ åˆ†ï¼
                    
                    if (['water', 'food', 'toilet', 'power'].some(t => item.tags.includes(t))) {
                        setInventory(prev => ({ ...prev, [item.id]: Math.max(0, prev[item.id] - 1) }));
                    }
                    
                    setTimeout(() => {
                        setShowEventModal(false);
                        setEventFeedback(null);
                        advanceJourney(currentEventIndex + 1, progress, journeyEvents);
                    }, 2000);
                } else {
                    setEventFeedback({ type: 'retry', text: 'é€™å€‹å¥½åƒæ²’ç”¨...å†è©¦è©¦åˆ¥çš„ï¼Ÿ', damage: 0 });
                    setTimeout(() => setEventFeedback(null), 1500);
                }
            };

            const handleNoItem = () => {
                const currentEvent = journeyEvents[currentEventIndex];
                setEventFeedback({ type: 'fail', text: currentEvent.fail });
                setHp(prev => Math.max(0, prev - currentEvent.damage));
                setJourneyLog(prev => [...prev, { event: currentEvent.text, result: 'fail', damage: currentEvent.damage }]);

                setTimeout(() => {
                    setShowEventModal(false);
                    setEventFeedback(null);
                    if (hp - currentEvent.damage <= 0) {
                        setScene('report');
                    } else {
                        advanceJourney(currentEventIndex + 1, progress, journeyEvents);
                    }
                }, 2500);
            };

            // 1. ä¸»é¸å–®
            if (scene === 'menu') {
                return (
                    <div className="h-screen w-full bg-yellow-400 flex flex-col items-center justify-center p-4 relative overflow-hidden">
                        <div className="absolute top-10 left-10 text-8xl animate-bounce opacity-20">ğŸ’</div>
                        <div className="absolute bottom-10 right-10 text-8xl animate-pulse opacity-20">ğŸ”¦</div>
                        
                        <div className="bg-white p-8 md:p-12 rounded-[2rem] border-8 border-black shadow-xl text-center max-w-lg w-full z-10 transform -rotate-1 flex flex-col items-center">
                            <div className="text-8xl md:text-9xl mb-4 animate-bounce inline-block">ğŸ»</div>
                            <h1 className="text-4xl md:text-6xl font-black mb-2 tracking-wider text-gray-900 leading-tight">æ³¢æ³¢ç†Šçš„<br/><span className="text-red-500">é˜²ç½æŒ‘æˆ°</span></h1>
                            <p className="text-xl md:text-2xl font-bold text-gray-500 mb-8">æº–å‚™å¥½é€ƒç”ŸèƒŒåŒ…äº†å—ï¼Ÿ</p>
                            
                            <button onClick={() => setScene('setup')} className="w-full bg-blue-500 hover:bg-blue-600 text-white border-4 border-black text-2xl md:text-3xl font-black py-4 md:py-5 rounded-2xl shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] hover:-translate-y-1 transition active:translate-y-0 active:shadow-none flex items-center justify-center gap-3">
                                <Play fill="currentColor" size={32}/> é–‹å§‹æŒ‘æˆ°
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. è¨­å®šé 
            if (scene === 'setup') {
                return (
                    <div className="h-screen w-full bg-sky-100 flex flex-col p-4 overflow-hidden">
                        <div className="flex-1 bg-white rounded-[2rem] border-4 border-black shadow-xl p-4 md:p-8 flex flex-col overflow-y-auto">
                            <h2 className="text-2xl md:text-3xl font-black mb-6 text-center flex items-center justify-center gap-2">
                                <Info size={32}/> è¨­å®šæƒ…å¢ƒ
                            </h2>
                            
                            <div className="space-y-6 flex-1">
                                <div>
                                    <h3 className="text-xl font-bold mb-3 border-l-4 border-yellow-400 pl-2">ç™¼ç”Ÿä»€éº¼äº‹ï¼Ÿ</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        {PROFILE_CONFIG.disasters.map(d => (
                                            <button key={d.id} onClick={() => setProfile({...profile, disaster: d.id})}
                                                className={`p-3 md:p-4 rounded-xl border-2 text-center transition-all ${profile.disaster === d.id ? 'bg-red-100 border-red-500 ring-2 ring-red-300' : 'bg-gray-50 border-gray-200'}`}>
                                                <div className="text-3xl md:text-4xl mb-1">{d.icon}</div>
                                                <div className="font-black text-lg md:text-xl">{d.label}</div>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold mb-3 border-l-4 border-yellow-400 pl-2">ç’°å¢ƒç‹€æ³ï¼Ÿ</h3>
                                    <div className="flex gap-3 mb-3">
                                        {PROFILE_CONFIG.seasons.map(s => (
                                            <button key={s.id} onClick={() => setProfile({...profile, season: s.id})}
                                                className={`flex-1 p-2 rounded-xl border-2 flex items-center justify-center gap-2 font-bold text-lg transition-all ${profile.season === s.id ? 'bg-blue-100 border-blue-500' : 'bg-gray-50 border-gray-200'}`}>
                                                {s.icon} {s.label}
                                            </button>
                                        ))}
                                    </div>
                                    <div className="flex gap-3">
                                        {PROFILE_CONFIG.times.map(t => (
                                            <button key={t.id} onClick={() => setProfile({...profile, time: t.id})}
                                                className={`flex-1 p-2 rounded-xl border-2 flex items-center justify-center gap-2 font-bold text-lg transition-all ${profile.time === t.id ? 'bg-indigo-100 border-indigo-500' : 'bg-gray-50 border-gray-200'}`}>
                                                {t.icon} {t.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                <div>
                                    <h3 className="text-xl font-bold mb-3 border-l-4 border-yellow-400 pl-2">ä½ çš„å¹´ç´šï¼Ÿ</h3>
                                    <div className="grid grid-cols-3 gap-2">
                                        {PROFILE_CONFIG.grades.map(g => (
                                            <button key={g.id} onClick={() => setProfile({...profile, grade: g.id})}
                                                className={`p-2 rounded-xl border-2 font-black text-lg transition-all ${profile.grade === g.id ? 'bg-green-100 border-green-500' : 'bg-gray-50 border-gray-200'}`}>
                                                {g.label}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            
                            <button onClick={() => setScene('packing')}
                                className="w-full mt-4 bg-black text-white border-4 border-gray-600 text-2xl font-black py-4 rounded-2xl shadow-lg active:scale-95 transition flex items-center justify-center gap-2">
                                <Backpack size={28}/> è¨­å®šå®Œæˆï¼Œå»æ‰“åŒ…ï¼
                            </button>
                        </div>
                    </div>
                );
            }

            // 3. æ‰“åŒ…é 
            if (scene === 'packing') {
                return (
                    <div className="h-screen w-full bg-[#FFF8E1] flex flex-col overflow-hidden">
                        <div className="bg-white border-b-4 border-black px-4 py-3 shadow-md z-10 flex flex-col gap-2 shrink-0">
                            <div className="flex justify-between items-center">
                                <div className="flex items-center gap-2">
                                    <span className="text-4xl animate-bounce">ğŸ </span>
                                    <div>
                                        <div className="font-black text-xl md:text-2xl leading-none text-red-600">ç·Šæ€¥æ’¤é›¢ï¼</div>
                                        <div className="text-xs md:text-sm font-bold text-gray-500 mt-0.5">
                                            {PROFILE_CONFIG.disasters.find(d=>d.id===profile.disaster).label}/{profile.season==='summer'?'å¤':'å†¬'}/{profile.time==='day'?'æ—¥':'å¤œ'}
                                        </div>
                                    </div>
                                </div>
                                <button onClick={startJourney}
                                    className="bg-red-500 hover:bg-red-600 text-white border-2 border-black font-black px-4 py-2 md:px-6 md:py-2 rounded-xl shadow-[3px_3px_0px_0px_#000] active:translate-y-1 active:shadow-none animate-pulse text-lg md:text-xl transition">
                                    å‡ºç™¼ï¼
                                </button>
                            </div>
                            
                            <div className="relative pt-1">
                                <div className="h-6 bg-gray-200 rounded-full border-2 border-black overflow-hidden">
                                    <div className={`h-full transition-all duration-300 ${currentWeight > currentMaxWeight ? 'bg-red-500' : 'bg-green-500'}`} style={{ width: `${Math.min(100, (currentWeight/currentMaxWeight)*100)}%` }}></div>
                                </div>
                                <div className="flex justify-between text-xs md:text-sm font-black mt-1">
                                    <span>ğŸ’ èƒŒåŒ…é‡é‡</span>
                                    <span className={currentWeight > currentMaxWeight ? 'text-red-600' : 'text-gray-600'}>{currentWeight} / {currentMaxWeight}g</span>
                                </div>
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col overflow-hidden">
                            <div className="flex overflow-x-auto p-2 gap-2 bg-[#FFECB3] flex-shrink-0 scrollbar-hide">
                                <button onClick={()=>setActiveTab(0)} className={`px-4 py-2 rounded-t-xl border-2 border-b-0 font-black text-base whitespace-nowrap ${activeTab===0 ? 'bg-black text-white border-black h-12 mt-0' : 'bg-white border-gray-400 h-10 mt-2 text-gray-500'}`}>å…¨éƒ¨</button>
                                {Object.entries(CATEGORIES).map(([k, v]) => (
                                    <button key={k} onClick={()=>setActiveTab(Number(k))} className={`px-4 py-2 rounded-t-xl border-2 border-b-0 font-black text-base whitespace-nowrap ${activeTab===Number(k) ? 'bg-black text-white border-black h-12 mt-0' : 'bg-white border-gray-400 h-10 mt-2 text-gray-500'}`}>{v}</button>
                                ))}
                            </div>

                            <div className="flex-1 overflow-y-auto p-3 grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-3 content-start bg-[#FFFDE7]">
                                {ITEMS_DB.filter(i => activeTab === 0 || i.type === activeTab).map(item => (
                                    <div key={item.id} className="bg-white border-2 border-black rounded-2xl p-2 flex flex-col justify-between shadow-sm relative group cursor-pointer active:scale-95 transition min-h-[140px]" onClick={() => handleItemToggle(item, 'add')}>
                                        <div className="text-center">
                                            <div className="text-5xl mb-1 transform group-hover:scale-110 transition filter drop-shadow-sm">{item.icon}</div>
                                            <div className="font-black text-base text-gray-800 leading-tight mb-1">{item.name}</div>
                                            <div className="text-[10px] text-gray-500 font-bold bg-gray-100 rounded-full inline-block px-2">{item.weight}g</div>
                                        </div>

                                        {inventory[item.id] > 0 ? (
                                            <div className="flex items-center justify-center gap-2 bg-blue-100 rounded-lg p-1 mt-auto border border-blue-300">
                                                <button onClick={(e) => {e.stopPropagation(); handleItemToggle(item, 'sub')}} className="w-6 h-6 flex items-center justify-center bg-white rounded-full border border-blue-300 text-blue-600"><Minus size={14} strokeWidth={3}/></button>
                                                <span className="font-black text-lg text-blue-800">{inventory[item.id]}</span>
                                                <button onClick={(e) => {e.stopPropagation(); handleItemToggle(item, 'add')}} className="w-6 h-6 flex items-center justify-center bg-white rounded-full border border-blue-300 text-blue-600"><RefreshCw size={14} strokeWidth={3} className="rotate-45"/></button>
                                            </div>
                                        ) : (
                                            <button className="w-full bg-gray-50 border-2 border-gray-300 border-dashed rounded-lg py-1.5 font-bold text-gray-400 text-sm mt-auto">æ”¾å…¥</button>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                );
            }

            // 4. æ—…ç¨‹é 
            if (scene === 'journey') {
                const currentEvent = journeyEvents[currentEventIndex];

                return (
                    <div className={`h-screen w-full flex flex-col relative transition-colors duration-1000 overflow-hidden ${profile.time === 'night' ? 'bg-slate-900 text-white' : 'bg-sky-300 text-black'}`}>
                        <div className="absolute inset-0 overflow-hidden pointer-events-none">
                            {profile.time === 'day' && <div className="absolute top-10 right-10 text-yellow-400 animate-spin-slow"><Sun size={80}/></div>}
                            {profile.time === 'night' && <div className="absolute top-10 right-10 text-yellow-100"><Moon size={60}/></div>}
                            {profile.season === 'winter' && <div className="absolute inset-0 bg-white/10 backdrop-blur-[1px]"></div>}
                            {profile.disaster === 'flood' && <div className="absolute bottom-0 w-full h-1/2 bg-blue-500/30 backdrop-blur-sm"></div>}
                            <div className="absolute bottom-0 w-full h-1/3 bg-gradient-to-t from-gray-700 to-transparent opacity-50"></div>
                        </div>

                        <div className="relative z-10 p-3 md:p-4 flex justify-between items-start bg-black/20 backdrop-blur-md border-b border-white/20 shadow-lg">
                            <div className="flex flex-col w-1/2 md:w-1/3">
                                <div className="w-full h-5 md:h-6 bg-gray-300 rounded-full overflow-hidden border-2 border-black shadow-inner relative mt-1">
                                    <div className="h-full bg-green-500 transition-all duration-300" style={{ width: `${progress}%` }}></div>
                                    <div className="absolute top-1/2 -translate-y-1/2 transition-all duration-300 text-xl md:text-2xl filter drop-shadow-md" style={{ left: `calc(${progress}% - 10px)` }}>ğŸ»</div>
                                </div>
                            </div>
                            <div className="w-1/3 flex flex-col gap-1">
                                <StatBar icon={<Heart size={24} className="text-red-500 fill-current"/>} value={hp} color="bg-red-500" />
                                <StatBar icon={<Star size={24} className="text-yellow-400 fill-current"/>} value={score} color="bg-yellow-400" max={600} />
                            </div>
                        </div>

                        <div className="flex-1 flex flex-col items-center justify-center relative z-10 p-4">
                            {!showEventModal && (
                                <div className="text-center animate-bounce-slow">
                                    <div className="text-[8rem] md:text-[10rem] transform scale-x-[-1] filter drop-shadow-2xl">ğŸ»</div>
                                    <div className="font-black text-2xl md:text-3xl mt-4 bg-white/90 px-6 py-2 rounded-full text-black inline-block shadow-xl border-4 border-black">
                                        è¶•è·¯ä¸­... {Math.round(progress)}%
                                    </div>
                                </div>
                            )}

                            {showEventModal && currentEvent && (
                                <div className="bg-white text-black p-6 md:p-8 rounded-[2rem] border-[6px] border-black shadow-[0_20px_60px_rgba(0,0,0,0.6)] max-w-xl w-full animate-pop-in z-50 flex flex-col max-h-[80vh]">
                                    {!eventFeedback ? (
                                        <>
                                            <div className="text-center mb-4 shrink-0">
                                                <div className="text-6xl md:text-8xl mb-2 animate-shake">
                                                    {currentEvent.conditions?.time === 'night' ? 'ğŸŒ‘' : 
                                                    currentEvent.conditions?.season === 'winter' ? 'ğŸ¥¶' :
                                                    currentEvent.conditions?.disaster === 'flood' ? 'ğŸŒ§ï¸' : 'âš ï¸'}
                                                </div>
                                                <h2 className="text-2xl md:text-3xl font-black mb-2 text-red-600 leading-tight">{currentEvent.text}</h2>
                                                <p className="text-gray-500 font-bold text-sm md:text-base bg-gray-100 inline-block px-3 py-1 rounded-full">è«‹é»æ“Šç‰©å“ä½¿ç”¨ï¼š</p>
                                            </div>
                                            
                                            <div className="bg-gray-100 p-3 rounded-2xl overflow-y-auto grid grid-cols-3 gap-2 border-[3px] border-gray-300 shadow-inner flex-1 min-h-[150px]">
                                                {Object.keys(inventory).length === 0 && <div className="col-span-3 text-center text-gray-400 py-10 font-bold">èƒŒåŒ…ç©ºç©ºçš„...</div>}
                                                {Object.keys(inventory).map(id => {
                                                    const item = ITEMS_DB.find(i => i.id === id);
                                                    if (!item) return null;
                                                    return (
                                                        <div key={id} onClick={() => handleUseItem(item)} 
                                                            className="bg-white border-2 border-gray-300 hover:border-blue-500 hover:bg-blue-50 rounded-xl p-2 flex flex-col items-center justify-center cursor-pointer transition active:scale-95 shadow-sm">
                                                            <span className="text-3xl md:text-4xl mb-1">{item.icon}</span>
                                                            <span className="text-xs font-black truncate w-full text-center">{item.name}</span>
                                                        </div>
                                                    )
                                                })}
                                            </div>

                                            <button onClick={handleNoItem} className="w-full mt-4 text-gray-400 text-base font-bold underline hover:text-red-500 shrink-0">
                                                æˆ‘æ²’æœ‰å¯ä»¥ç”¨çš„æ±è¥¿... (æ‰£è¡€)
                                            </button>
                                        </>
                                    ) : (
                                        <div className="text-center py-10 flex flex-col items-center justify-center h-full">
                                            <div className="text-8xl mb-6 animate-bounce">{eventFeedback.type === 'success' ? 'âœ…' : 'âŒ'}</div>
                                            <h3 className={`text-3xl md:text-4xl font-black mb-4 ${eventFeedback.type === 'success' ? 'text-green-600' : 'text-red-600'}`}>
                                                {eventFeedback.type === 'success' ? 'è§£æ±ºäº†ï¼+100åˆ†' : 'ç³Ÿäº†ï¼'}
                                            </h3>
                                            <p className="font-bold text-gray-700 text-xl leading-relaxed">{eventFeedback.text}</p>
                                            {eventFeedback.type === 'retry' && <div className="mt-4 text-orange-500 font-bold animate-pulse">æ­£åœ¨é‡æ–°æ€è€ƒ...</div>}
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>

                        <div className="h-16 md:h-24 bg-gray-800 w-full relative z-0 flex items-end overflow-hidden border-t-4 border-black shrink-0">
                            <div className="flex gap-40 animate-slide text-4xl md:text-6xl opacity-50 absolute bottom-4 w-[200%]">
                                <span>ğŸšï¸</span><span>ğŸŒ²</span><span>ğŸŒŠ</span><span>ğŸš‘</span><span>ğŸšï¸</span><span>ğŸŒ²</span><span>ğŸŒŠ</span>
                            </div>
                        </div>
                    </div>
                );
            }

            // 5. çµç®—å ±å‘Š
            if (scene === 'report') {
                const isSuccess = hp > 0;
                const finalScore = score;
                let rank = 'C';
                if (finalScore >= 500) rank = 'S';
                else if (finalScore >= 400) rank = 'A';
                else if (finalScore >= 300) rank = 'B';
                
                return (
                    <div className="h-screen w-full bg-indigo-900 flex flex-col items-center justify-center p-4 relative">
                        {isSuccess && <div className="absolute top-0 left-0 w-full h-full pointer-events-none opacity-20 bg-[url('https://www.transparenttextures.com/patterns/confetti.png')]"></div>}
                        
                        <div className="bg-white p-6 md:p-10 rounded-[2.5rem] border-8 border-black shadow-2xl max-w-2xl w-full text-center z-10 relative flex flex-col max-h-screen">
                            <div className="text-7xl md:text-9xl -mt-16 md:-mt-20 mb-4 filter drop-shadow-lg">
                                {isSuccess ? 'ğŸ•ï¸' : 'ğŸš‘'}
                            </div>
                            
                            <h2 className={`text-4xl md:text-6xl font-black mb-2 ${isSuccess ? 'text-green-600' : 'text-red-600'}`}>
                                {isSuccess ? 'æŠµé”æ”¶å®¹æ‰€ï¼' : 'ä»»å‹™å¤±æ•—...'}
                            </h2>
                            
                            <div className="flex justify-center items-center gap-4 my-4">
                                <div className="bg-yellow-100 p-4 rounded-2xl border-4 border-yellow-400">
                                    <div className="text-xs font-bold text-gray-500">æœ€çµ‚å¾—åˆ†</div>
                                    <div className="text-4xl font-black text-yellow-600">{finalScore}</div>
                                </div>
                                <div className="bg-blue-100 p-4 rounded-2xl border-4 border-blue-400">
                                    <div className="text-xs font-bold text-gray-500">ç”Ÿå­˜è©•åƒ¹</div>
                                    <div className="text-4xl font-black text-blue-600">{rank}</div>
                                </div>
                            </div>

                            <div className="bg-gray-100 rounded-3xl p-4 text-left mb-6 border-[3px] border-gray-300 flex-1 overflow-y-auto">
                                <div className="space-y-2">
                                    {journeyLog.length === 0 && <span className="text-gray-400 text-lg font-bold">ä¸€è·¯ä¸Šéå¸¸é †åˆ©ï¼Œæ²’æœ‰å—å‚·ï¼</span>}
                                    {journeyLog.map((log, i) => (
                                        <div key={i} className="text-red-700 font-bold flex items-start bg-red-50 p-2 rounded-xl border border-red-200">
                                            <XCircle size={20} className="mr-2 flex-shrink-0 mt-0.5"/> 
                                            <div>
                                                <div>{log.event}</div>
                                                <div className="text-xs opacity-70">æ‰£é™¤ {log.damage} HP</div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            <button onClick={() => setScene('menu')} className="w-full bg-blue-500 hover:bg-blue-600 text-white text-2xl font-black py-4 rounded-2xl shadow-lg active:scale-95 transition border-4 border-black shrink-0">
                                <RefreshCw className="inline-block mr-2 mb-1"/> å†æ¬¡æŒ‘æˆ°
                            </button>
                        </div>
                    </div>
                );
            }

            return null;
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<SurvivalGame />);
    </script>
</body>
</html>